ğŸ”‘ Giáº£i thÃ­ch
reset_db.sh: xÃ³a file SQLite cÅ©, táº¡o láº¡i tá»« init.sql.

load_sample.sh: náº¡p dá»¯ liá»‡u máº«u tá»« sample.sql.

run_dev.sh: cháº¡y server dev vá»›i reload.

run_prod.sh: cháº¡y server production báº±ng gunicorn.


1. NhÃ³m File Cáº§n Táº¡o Má»›i (Core Logic)
ÄÃ¢y lÃ  nhá»¯ng file chá»©a "bá»™ nÃ£o" xá»­ lÃ½ camera vÃ  AI Ä‘á»ƒ khÃ´ng lÃ m treo mÃ¡y.

app/services/ai_worker.py

Nhiá»‡m vá»¥: ÄÃ¢y lÃ  file cháº¡y trÃªn má»™t Process (tiáº¿n trÃ¬nh) hoÃ n toÃ n riÃªng biá»‡t. NÃ³ chá»‹u trÃ¡ch nhiá»‡m load model YOLO vÃ  nháº­n áº£nh Ä‘á»ƒ phÃ¡t hiá»‡n ngÆ°á»i.

Táº¡i sao cáº§n: Äá»ƒ tÃ¡ch viá»‡c tÃ­nh toÃ¡n náº·ng ra khá»i luá»“ng chÃ­nh, giÃºp video khÃ´ng bá»‹ khá»±ng khi AI Ä‘ang "suy nghÄ©".

app/services/camera_manager.py

Nhiá»‡m vá»¥: ÄÃ¢y lÃ  "ngÆ°á»i quáº£n lÃ½" chÃ­nh (Main Process).

Quáº£n lÃ½ káº¿t ná»‘i pháº§n cá»©ng Camera (OpenCV).

Táº¡o cÃ¡c luá»“ng con (Threads): Luá»“ng Ä‘á»c cam, Luá»“ng ghi tháº» nhá»›, Luá»“ng gá»­i áº£nh sang AI.

Quáº£n lÃ½ hÃ ng Ä‘á»£i (Queue) giao tiáº¿p vá»›i ai_worker.py.

LÆ°u Ã½: File nÃ y thay tháº¿ vai trÃ² xá»­ lÃ½ luá»“ng cá»§a camera_service.py cÅ© (file cÅ© chá»‰ nÃªn giá»¯ láº¡i Ä‘á»ƒ thao tÃ¡c Database CRUD).

app/utils/draw_utils.py

Nhiá»‡m vá»¥: Chá»©a hÃ m váº½ chá»¯ "Viá»n Ä‘en - LÃµi tráº¯ng" vÃ  váº½ khung cáº£nh bÃ¡o.

Táº¡i sao cáº§n: TÃ¡ch biá»‡t code váº½ vá»i ra khá»i logic xá»­ lÃ½ Ä‘á»ƒ code gá»n gÃ ng, dá»… sá»­a font chá»¯ hay mÃ u sáº¯c sau nÃ y.

app/models/ (ThÆ° má»¥c má»›i)

Nhiá»‡m vá»¥: Báº¡n cáº§n táº¡o thÆ° má»¥c nÃ y vÃ  bá» file model vÃ o (vÃ­ dá»¥: yolov8n_int8.tflite).

2. NhÃ³m File Cáº§n Sá»­a Äá»•i (Integration)
Báº¡n cáº§n sá»­a cÃ¡c file nÃ y Ä‘á»ƒ há»‡ thá»‘ng cÅ© gá»i Ä‘Æ°á»£c vÃ o há»‡ thá»‘ng má»›i.

app/api/routers/camera_router.py

Cáº§n lÃ m gÃ¬:

ThÃªm API GET /{id}/stream: Äá»ƒ tráº£ vá» luá»“ng video MJPEG cho tháº» <img> á»Ÿ Client.

ThÃªm API GET /{id}/ai-overlay: Äá»ƒ Client láº¥y tá»a Ä‘á»™ váº½ khung (náº¿u cáº§n).

ThÃªm API POST /{id}/record: Äá»ƒ nháº­n lá»‡nh Báº¯t Ä‘áº§u/Dá»«ng quay video.

Káº¿t ná»‘i cÃ¡c API nÃ y vÃ o camera_manager.py thay vÃ¬ code xá»­ lÃ½ cÅ©.

app/main.py

Cáº§n lÃ m gÃ¬:

Sá»­ dá»¥ng sá»± kiá»‡n @app.on_event("startup") Ä‘á»ƒ khá»Ÿi Ä‘á»™ng CameraSystem (báº­t AI Process vÃ  Camera ngay khi Server cháº¡y).

Sá»­ dá»¥ng @app.on_event("shutdown") Ä‘á»ƒ táº¯t camera vÃ  giáº£i phÃ³ng tÃ i nguyÃªn an toÃ n khi táº¯t Server.

app/core/config.py

Cáº§n lÃ m gÃ¬: ThÃªm cÃ¡c biáº¿n cáº¥u hÃ¬nh nhÆ° Ä‘Æ°á»ng dáº«n tá»›i file model AI, Ä‘á»™ phÃ¢n giáº£i camera mong muá»‘n, hoáº·c thÆ° má»¥c lÆ°u video (VIDEO_STORAGE_PATH).

TÃ³m táº¯t luá»“ng cÃ´ng viá»‡c:
BÆ°á»›c 1: Táº£i model .tflite vá» vÃ  táº¡o folder app/models.

BÆ°á»›c 2: Viáº¿t app/utils/draw_utils.py (Logic váº½ Ä‘Æ¡n giáº£n nháº¥t).

BÆ°á»›c 3: Viáº¿t app/services/ai_worker.py (Logic xá»­ lÃ½ AI Ä‘á»™c láº­p).

BÆ°á»›c 4: Viáº¿t app/services/camera_manager.py (Logic quáº£n lÃ½ cam, káº¿t ná»‘i AI).

BÆ°á»›c 5: Sá»­a app/api/routers/camera_router.py Ä‘á»ƒ má»Ÿ API cho Client gá»i.

BÆ°á»›c 6: Sá»­a app/main.py Ä‘á»ƒ kÃ­ch hoáº¡t má»i thá»©.